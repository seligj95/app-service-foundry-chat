@page "/"
@using ChatApp.Services
@using ChatApp.Models
@inject IChatService ChatService
@inject IJSRuntime JS
@inject ILogger<Home> Logger
@implements IDisposable

<PageTitle>Foundry Chat</PageTitle>

<div class="chat-container">
    <header class="chat-header">
        <div class="header-top">
            <h1>Foundry Chat</h1>
            <div class="header-actions">
                <button class="settings-btn" @onclick="ToggleSettings" title="Change Foundry endpoint or model deployment">
                    ‚öôÔ∏è Settings
                </button>
                @if (_messages.Count > 0)
                {
                    <button class="clear-btn" @onclick="ClearChat" title="Clear chat">
                        <span>üóë</span> Clear
                    </button>
                }
            </div>
        </div>
        
        <div class="status-row">
            <div class="status @(_isConfigured ? "connected" : "disconnected")">
                @if (_isConfigured)
                {
                    <span>‚úì Connected</span>
                }
                else
                {
                    <span>‚ö† Configure Connection</span>
                }
            </div>
            
            @if (_isConfigured)
            {
                <button class="ping-btn @(_isPinging ? "pinging" : "") @(_pingStatus)" @onclick="RunHealthCheck" disabled="@_isPinging">
                    @if (_isPinging)
                    {
                        <span>Testing...</span>
                    }
                    else if (_pingStatus == "success")
                    {
                        <span>‚úì Connected (@(_lastPingMs)ms)</span>
                    }
                    else if (_pingStatus == "failed")
                    {
                        <span>‚úó Failed</span>
                    }
                    else
                    {
                        <span>üèì Test Connection</span>
                    }
                </button>
            }
        </div>

        <div class="service-info">
            <span class="info-item" title="AI Endpoint">üåê @(string.IsNullOrEmpty(_endpoint) ? "Not configured" : _endpoint)</span>
            <span class="info-item" title="Model Deployment">ü§ñ @_modelDeployment</span>
        </div>
        
        <div class="app-description">
            Test and validate your Foundry connection. Use <strong>Settings</strong> to connect to a different endpoint or model.
        </div>
    </header>

    @if (_showSettings)
    {
        <div class="settings-panel">
            <h3>Connection Settings</h3>
            <p class="settings-hint">
                @if (_hasDefaultConfig)
                {
                    <span>Default values loaded from app settings. Override below to test with a different resource.</span>
                }
                else
                {
                    <span>No default configuration found. Enter your Foundry connection details.</span>
                }
            </p>
            
            <div class="settings-form">
                <div class="form-group">
                    <label for="endpoint">Foundry Endpoint</label>
                    <input 
                        id="endpoint"
                        type="text" 
                        @bind="_endpoint" 
                        placeholder="https://your-resource.cognitiveservices.azure.com/"
                        class="form-input" />
                </div>
                
                <div class="form-group">
                    <label for="model">Model Deployment Name</label>
                    <input 
                        id="model"
                        type="text" 
                        @bind="_modelDeployment" 
                        placeholder="gpt-4o"
                        class="form-input" />
                </div>
                
                <div class="settings-actions">
                    @if (_hasDefaultConfig)
                    {
                        <button class="btn-secondary" @onclick="ResetToDefaults">Reset to Defaults</button>
                    }
                    <button class="btn-primary" @onclick="ApplySettings" disabled="@(!CanApplySettings)">
                        Apply & Connect
                    </button>
                </div>
            </div>
        </div>
    }

    @if (!_isConfigured && !_showSettings)
    {
        <div class="error-banner clickable" @onclick="ToggleSettings">
            <strong>Setup Required:</strong> Click here or the ‚öôÔ∏è button to configure your Foundry connection.
        </div>
    }

    <div class="messages-container" @ref="_messagesContainer">
        @if (_messages.Count == 0 && _isConfigured)
        {
            <div class="welcome-message">
                <div class="welcome-icon">üí¨</div>
                <h2>Welcome to Foundry Chat</h2>
                <p>Your connection is ready. Send a message to test the AI service.</p>
                <div class="quick-prompts">
                    <button class="quick-prompt" @onclick="@(() => SendQuickPrompt("Hello! Tell me about yourself."))">
                        üëã Say hello
                    </button>
                    <button class="quick-prompt" @onclick="@(() => SendQuickPrompt("What can you help me with?"))">
                        ‚ùì What can you do?
                    </button>
                    <button class="quick-prompt" @onclick="@(() => SendQuickPrompt("Tell me a short fun fact."))">
                        üé≤ Fun fact
                    </button>
                </div>
            </div>
        }

        @foreach (var message in _messages)
        {
            <div class="message @message.Role">
                <div class="message-content">
                    <div class="message-text">@message.Content</div>
                    @if (message.Role == "assistant" && message.Metrics != null)
                    {
                        <div class="message-metrics">
                            <span>Response: @(message.Metrics.ResponseTimeMs)ms</span>
                            <span>Tokens: @(message.Metrics.TotalTokens) <span class="token-detail">(@(message.Metrics.PromptTokens) in / @(message.Metrics.CompletionTokens) out)</span></span>
                        </div>
                    }
                    <div class="message-timestamp">@message.Timestamp.ToString("HH:mm:ss")</div>
                </div>
            </div>
        }

        @if (_isLoading)
        {
            <div class="message assistant">
                <div class="message-content">
                    <div class="message-text loading">
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="message error">
                <div class="message-content">
                    <strong>Error:</strong> @_errorMessage
                </div>
            </div>
        }
    </div>

    <div class="session-stats">
        <span>Messages: @_messages.Count</span>
        <span>Session tokens: @_sessionTotalTokens</span>
    </div>

    <div class="input-container">
        <textarea 
            @ref="_textareaRef"
            @bind="_userInput" 
            @bind:event="oninput"
            @bind:after="AutoResizeTextarea"
            @onkeydown="HandleKeyDown"
            placeholder="Type a message..." 
            disabled="@(!_isConfigured || _isLoading)"
            class="message-input"
            rows="1"></textarea>
        <button 
            type="button"
            @onclick="SendMessage"
            disabled="@(!_isConfigured || _isLoading || string.IsNullOrWhiteSpace(_userInput))"
            class="send-button">
            Send
        </button>
    </div>
</div>

@code {
    private readonly string _conversationId = Guid.NewGuid().ToString();
    private CancellationTokenSource _cts = new();
    private List<ChatMessageViewModel> _messages = new();
    private string _userInput = string.Empty;
    private string? _errorMessage;
    private bool _isLoading;
    private bool _isPinging;
    private long? _lastPingMs;
    private string _pingStatus = ""; // "", "success", "failed"
    private int _sessionTotalTokens;
    private ElementReference _messagesContainer;
    private ElementReference _textareaRef;
    
    // Configuration state
    private bool _showSettings;
    private bool _hasDefaultConfig;
    private string _endpoint = string.Empty;
    private string _modelDeployment = "gpt-4o";
    
    private bool _isConfigured => !string.IsNullOrWhiteSpace(_endpoint) && !string.IsNullOrWhiteSpace(_modelDeployment);
    private bool CanApplySettings => !string.IsNullOrWhiteSpace(_endpoint) && !string.IsNullOrWhiteSpace(_modelDeployment);

    private ConnectionConfig? GetCurrentConfig() => _isConfigured 
        ? new ConnectionConfig(_endpoint.Trim(), _modelDeployment.Trim()) 
        : null;

    protected override void OnInitialized()
    {
        var defaultConfig = ChatService.GetDefaultConfig();
        _hasDefaultConfig = defaultConfig != null;
        
        if (defaultConfig != null)
        {
            _endpoint = defaultConfig.Endpoint;
            _modelDeployment = defaultConfig.ModelDeployment;
        }
        else
        {
            _showSettings = true; // Auto-show settings if no defaults
        }
    }

    private void ToggleSettings()
    {
        _showSettings = !_showSettings;
    }

    private void ResetToDefaults()
    {
        var defaultConfig = ChatService.GetDefaultConfig();
        if (defaultConfig != null)
        {
            _endpoint = defaultConfig.Endpoint;
            _modelDeployment = defaultConfig.ModelDeployment;
        }
    }

    private async Task ApplySettings()
    {
        if (!CanApplySettings) return;
        
        _showSettings = false;
        _pingStatus = "";
        _errorMessage = null;
        
        // Clear conversation when config changes
        _messages.Clear();
        _sessionTotalTokens = 0;
        ChatService.ClearConversation(_conversationId);
        
        // Auto-test the connection
        await RunHealthCheck();
    }

    private async Task AutoResizeTextarea()
    {
        try
        {
            await JS.InvokeVoidAsync("chatInterop.resizeTextarea", ".message-input");
        }
        catch (Exception ex)
        {
            Logger.LogDebug(ex, "Failed to resize textarea");
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey && !string.IsNullOrWhiteSpace(_userInput))
        {
            await SendMessage();
        }
    }

    private async Task RunHealthCheck()
    {
        var config = GetCurrentConfig();
        if (config == null) return;
        
        _isPinging = true;
        _pingStatus = "";
        _errorMessage = null;
        StateHasChanged();

        try
        {
            _lastPingMs = await ChatService.PingAsync(config, _cts.Token);
            _pingStatus = "success";
        }
        catch (OperationCanceledException)
        {
            Logger.LogDebug("Health check was cancelled");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Health check failed: {ex.Message}";
            _lastPingMs = null;
            _pingStatus = "failed";
            Logger.LogWarning(ex, "Health check failed");
        }
        finally
        {
            _isPinging = false;
            StateHasChanged();
        }
    }

    private void ClearChat()
    {
        _messages.Clear();
        _errorMessage = null;
        _sessionTotalTokens = 0;
        ChatService.ClearConversation(_conversationId);
        StateHasChanged();
    }

    private async Task SendQuickPrompt(string prompt)
    {
        _userInput = prompt;
        await SendMessage();
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_userInput) || _isLoading || !_isConfigured)
            return;

        var config = GetCurrentConfig();
        if (config == null) return;

        var userMessage = _userInput.Trim();
        _userInput = string.Empty;
        _errorMessage = null;

        _messages.Add(new ChatMessageViewModel("user", userMessage, DateTime.UtcNow, null));
        _isLoading = true;
        StateHasChanged();
        await ScrollToBottom();

        try
        {
            var response = await ChatService.SendMessageAsync(_conversationId, userMessage, config, _cts.Token);
            var metrics = new MessageMetrics(
                response.PromptTokens,
                response.CompletionTokens,
                response.TotalTokens,
                response.ResponseTimeMs
            );
            _messages.Add(new ChatMessageViewModel("assistant", response.Content, DateTime.UtcNow, metrics));
            _sessionTotalTokens += response.TotalTokens;
        }
        catch (OperationCanceledException)
        {
            Logger.LogDebug("Message send was cancelled");
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            Logger.LogError(ex, "Failed to send message");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
            await ScrollToBottom();
            await ResetTextareaHeight();
        }
    }

    private async Task ResetTextareaHeight()
    {
        try
        {
            await JS.InvokeVoidAsync("chatInterop.resetTextareaHeight", ".message-input");
        }
        catch (Exception ex)
        {
            Logger.LogDebug(ex, "Failed to reset textarea height");
        }
    }

    private async Task ScrollToBottom()
    {
        await Task.Delay(50);
        try
        {
            await JS.InvokeVoidAsync("chatInterop.scrollToBottom", ".messages-container");
        }
        catch (Exception ex)
        {
            Logger.LogDebug(ex, "Failed to scroll to bottom");
        }
    }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
    }
}
